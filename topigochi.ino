/*
 * Topigochi - Arduino UNO R4
 * Control de pantalla OLED 0.96" con 3 botones
 */

#include <Wire.h>
#include <Adafruit_GFX.h>
#include <Adafruit_SSD1306.h>
#include <EEPROM.h>

// Configuración del display OLED
#define SCREEN_WIDTH 128
#define SCREEN_HEIGHT 64
#define OLED_RESET -1
Adafruit_SSD1306 display(SCREEN_WIDTH, SCREEN_HEIGHT, &Wire, OLED_RESET);

// Pines de los botones
#define BOTON_1 2  // Moverse por el menú
#define BOTON_2 3  // Ejecutar acción
#define BOTON_3 4  // Cancelar

// Tiempo interno
unsigned long tiempoInicioSesion = 0;
unsigned long tiempoAcumulado = 0;
unsigned long tiempoActual = 0;
unsigned long tiempoTranscurrido = 0;
unsigned long tiempoUltimoGuardado = 0;

// Intervalos de tiempo para eventos
// Variables para fases y evolución
int faseActual = 0;
unsigned long tiempoTransicionFase = 60000; // huevo a bebe (10 minutos)
unsigned long intervaloComida = 86400000;
unsigned long intervaloLimpieza = 86400000;
unsigned long intervaloMaldad = 86400000;
unsigned long intervaloAburrimiento = 86400000;
unsigned long intervaloEnfermedad = 86400000;

// Variación en los eventos
const unsigned long variacionMaxima = 1800000; //30 minutos

// Última vez de la acción
unsigned long lastComida = 0;
unsigned long lastLimpieza = 0;
unsigned long lastMaldad = 0;
unsigned long lastAburrimiento = 0;
unsigned long lastEnfermedad = 0;

// Pin del buzzer
#define BUZZER 8

// Variables para debounce
unsigned long lastDebounceTime = 0;
unsigned long debounceDelay = 50;

// Variables para timeout del menú
unsigned long ultimaInteraccion = 0;
const unsigned long TIMEOUT_MENU = 5000; // 5 segundos en milisegundos
bool menuActivo = false;

// Animation State
bool isAnimationRunning = false;
int animationFrame = 0;
unsigned long lastFrameTime = 0;
const unsigned long frameDelay = 300; // 300ms entre frames

// Variables para mensajes temporales
unsigned long mensajeMostradoHasta = 0;
bool mostrandoMensaje = false;

// Marca de validación para EEPROM
#define EEPROM_MAGIC 0xABCD
#define EEPROM_MAGIC_ADDR 0

// ========================================
// ESTRUCTURA DE LA MASCOTA
// ========================================
struct Mascota {
  char fase[10];
  int salud;
  int felicidad;
  int saciado;
  int limpieza;
  int educacion;
  int enfermedad;
  unsigned long tiempoVivo;
  bool isDead;
  bool despierto;
};

// Instancia global de la mascota
Mascota miMascota;

// ========================================
// BITMAPS (tus arrays originales)
// ========================================
// 'Acariciar', 32x16px
const unsigned char epd_bitmap_Acariciar [] PROGMEM = {
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0e, 0x70, 0x00,
  0x00, 0x1f, 0xf8, 0x00, 0x00, 0x1f, 0xf8, 0x00, 0x00, 0x1f, 0xf8, 0x00, 0x00, 0x0f, 0xf0, 0x00,
  0x00, 0x07, 0xe0, 0x00, 0x00, 0x03, 0xc0, 0x00, 0x00, 0x01, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};
// 'Alarma', 32x16px
const unsigned char epd_bitmap_Alarma [] PROGMEM = {
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x80, 0x00, 0x00, 0x02, 0x40, 0x00,
  0x00, 0x04, 0x20, 0x00, 0x00, 0x09, 0x90, 0x00, 0x00, 0x09, 0x90, 0x00, 0x00, 0x09, 0x90, 0x00,
  0x00, 0x10, 0x08, 0x00, 0x00, 0x21, 0x84, 0x00, 0x00, 0x20, 0x04, 0x00, 0x00, 0x3f, 0xfc, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};
// 'Comer', 32x16px
const unsigned char epd_bitmap_Comer [] PROGMEM = {
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x2a, 0x30, 0x00,
  0x00, 0x2a, 0x30, 0x00, 0x00, 0x2a, 0x30, 0x00, 0x00, 0x1c, 0x30, 0x00, 0x00, 0x08, 0x30, 0x00,
  0x00, 0x08, 0x20, 0x00, 0x00, 0x08, 0x20, 0x00, 0x00, 0x08, 0x20, 0x00, 0x00, 0x08, 0x30, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};
// 'Curar', 32x16px
const unsigned char epd_bitmap_Curar [] PROGMEM = {
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0xc0, 0x00,
  0x00, 0x03, 0xc0, 0x00, 0x00, 0x03, 0xc0, 0x00, 0x00, 0x1f, 0xf8, 0x00, 0x00, 0x1f, 0xf8, 0x00,
  0x00, 0x1f, 0xf8, 0x00, 0x00, 0x1f, 0xf8, 0x00, 0x00, 0x03, 0xc0, 0x00, 0x00, 0x03, 0xc0, 0x00,
  0x00, 0x03, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};
// 'Educar', 32x16px
const unsigned char epd_bitmap_Educar [] PROGMEM = {
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x60, 0x00, 0x00, 0x00, 0x50, 0x00,
  0x00, 0x00, 0x50, 0x00, 0x00, 0x0a, 0xd0, 0x00, 0x00, 0x15, 0x50, 0x00, 0x00, 0x14, 0xf0, 0x00,
  0x00, 0x11, 0x10, 0x00, 0x00, 0x10, 0x30, 0x00, 0x00, 0x1c, 0x60, 0x00, 0x00, 0x07, 0xc0, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};
// 'Limpiar', 32x16px
const unsigned char epd_bitmap_Limpiar [] PROGMEM = {
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0x00,
  0x00, 0x00, 0x38, 0x00, 0x00, 0x00, 0x70, 0x00, 0x00, 0x00, 0xe0, 0x00, 0x00, 0x1d, 0xc0, 0x00,
  0x00, 0x3f, 0x80, 0x00, 0x00, 0x3f, 0x80, 0x00, 0x00, 0x4f, 0xc0, 0x00, 0x00, 0x13, 0xc0, 0x00,
  0x00, 0x04, 0xc0, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};
// 'Luz', 32x16px
const unsigned char epd_bitmap_Luz [] PROGMEM = {
  0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0xe0, 0x00, 0x00, 0x1f, 0xfc, 0x00, 0x00, 0x3f, 0xfe, 0x00,
  0x00, 0x3f, 0xfe, 0x00, 0x00, 0x3f, 0xfe, 0x00, 0x00, 0x3f, 0xfe, 0x00, 0x00, 0x3f, 0xfe, 0x00,
  0x00, 0x00, 0x88, 0x00, 0x00, 0x00, 0x88, 0x00, 0x00, 0x01, 0xc4, 0x00, 0x00, 0x03, 0xe0, 0x00,
  0x00, 0x03, 0xe0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};
// 'Lupa', 32x16px
const unsigned char epd_bitmap_Lupa [] PROGMEM = {
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0f, 0xc0, 0x00, 0x00, 0x10, 0x20, 0x00,
  0x00, 0x20, 0x10, 0x00, 0x00, 0x40, 0x08, 0x00, 0x00, 0x40, 0x08, 0x00, 0x00, 0x40, 0x08, 0x00,
  0x00, 0x20, 0x18, 0x00, 0x00, 0x10, 0x3c, 0x00, 0x00, 0x0f, 0xfc, 0x00, 0x00, 0x00, 0x1e, 0x00,
  0x00, 0x00, 0x07, 0x00, 0x00, 0x00, 0x03, 0x80, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00
};

// 'Died', 128x32px
const unsigned char epd_bitmap_Died [] PROGMEM = {
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x80, 0x78, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x00, 0x0c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x00, 0x04, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x04, 0x00, 0x06, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x08, 0x0f, 0x81, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x19, 0xe2, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0xc0, 0x00, 0x11, 0x32, 0x79, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x01, 0x80, 0x00, 0x11, 0x12, 0x4c, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x03, 0xc0, 0x00, 0x31, 0x12, 0x44, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x02, 0x60, 0x00, 0x21, 0x32, 0x44, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x30, 0x00, 0x21, 0xe2, 0x7c, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0x00, 0x21, 0xc2, 0x40, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x41, 0x62, 0x40, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x06, 0x00, 0x41, 0x2f, 0x40, 0x20, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x30, 0x40, 0x00, 0x00, 0x20, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0xf8, 0x40, 0x00, 0x00, 0x20, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0x88, 0x40, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x04, 0x0b, 0xff, 0xff, 0xff, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x06, 0x1c, 0x00, 0x00, 0x01, 0xf0, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x70, 0x00, 0x00, 0x00, 0x1c, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0xc0, 0x20, 0x80, 0x38, 0x07, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0x00, 0x40, 0x00, 0x8c, 0x01, 0x80, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x80, 0x86, 0x00, 0xc0, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0x22, 0x00, 0x18, 0x00, 0x88, 0x60, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x20, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00
};

// 'Huevo', 128x32px
const unsigned char epd_bitmap_Huevo [] PROGMEM = {
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1f, 0x00, 0x07, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xe0, 0x00, 0x00, 0x78, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x00, 0x07, 0xe0, 0x7e, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x0f, 0xf0, 0x3f, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x10, 0x00, 0x0f, 0xf8, 0x3f, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x3c, 0x00, 0x07, 0xf8, 0x1f, 0xa0, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x7c, 0x00, 0x01, 0xf0, 0x00, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0xfc, 0x0c, 0x00, 0x00, 0x00, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x01, 0x7c, 0x0e, 0x00, 0x00, 0x00, 0x1c, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x01, 0x78, 0x1b, 0x00, 0x00, 0x0c, 0x1c, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x02, 0x00, 0x31, 0x8f, 0x00, 0x1e, 0x1e, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x02, 0x00, 0x60, 0xdf, 0x80, 0x63, 0x1e, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x02, 0x00, 0x40, 0x6f, 0xc0, 0xc1, 0x8e, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x03, 0x00, 0xc0, 0x1b, 0xc3, 0x80, 0xc6, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x03, 0xc1, 0x80, 0xe7, 0xc6, 0x00, 0x67, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x01, 0x73, 0x00, 0xfb, 0x1c, 0x00, 0x3f, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x01, 0x9c, 0x00, 0xfd, 0xf0, 0x00, 0x06, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x00, 0xfe, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0xc0, 0x00, 0x7e, 0x01, 0xf0, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x60, 0x00, 0x00, 0x07, 0xf8, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x31, 0xf0, 0x00, 0x0f, 0xf8, 0x60, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x1b, 0xf8, 0x00, 0x0f, 0xf9, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0xfc, 0x00, 0x0f, 0xfe, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0xfc, 0x00, 0x07, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7f, 0x00, 0x7f, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0f, 0xff, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};

// 'Bichonejo1', 128x32px
const unsigned char epd_bitmap_Bichonejo1 [] PROGMEM = {
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x10, 0x08, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x28, 0x14, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x44, 0x22, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x54, 0x2a, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x52, 0x4a, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x51, 0x8a, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x41, 0x82, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xe1, 0x87, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x18, 0x18, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x24, 0x24, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x3c, 0x3c, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x19, 0x98, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x85, 0xa1, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x43, 0xc2, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xb8, 0x1d, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x8f, 0xf1, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x80, 0x01, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x04, 0x01, 0x80, 0x20, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x04, 0x46, 0x62, 0x20, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x06, 0x84, 0x21, 0x60, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x86, 0x61, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x41, 0x82, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x60, 0x06, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x38, 0x1c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xd5, 0xab, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};
// 'Bichonejo2', 128x32px
const unsigned char epd_bitmap_Bichonejo2 [] PROGMEM = {
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x10, 0x08, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x28, 0x14, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x44, 0x22, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x54, 0x2a, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x52, 0x4a, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x51, 0x8a, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x41, 0x82, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xe1, 0x87, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x18, 0x18, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x34, 0x34, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x3c, 0x3c, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x19, 0x98, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x85, 0xa1, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x43, 0xc2, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xb8, 0x1d, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x8f, 0xf1, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x80, 0x01, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x04, 0x01, 0x80, 0x20, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x04, 0x46, 0x62, 0x20, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x06, 0x84, 0x21, 0x60, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x86, 0x61, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x41, 0x82, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x60, 0x06, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x38, 0x1c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xd5, 0xab, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};
// 'Bichonejo4', 128x32px
const unsigned char epd_bitmap_Bichonejo4 [] PROGMEM = {
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x40, 0x20, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xa0, 0x50, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x10, 0x88, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x50, 0xa8, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x49, 0x28, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x46, 0x28, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x06, 0x08, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x86, 0x1c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x00, 0x04, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x04, 0x60, 0x62, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x08, 0xd0, 0xd1, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0c, 0xf0, 0xf3, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x08, 0x06, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x04, 0x00, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x16, 0x04, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x0f, 0x08, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0xe0, 0x74, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x06, 0x3f, 0xc6, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0e, 0x00, 0x07, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x10, 0x06, 0x00, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x11, 0x19, 0x88, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1a, 0x10, 0x85, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0e, 0x19, 0x87, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x06, 0x08, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x80, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xe0, 0x70, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x56, 0xac, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0xff, 0xfc, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};
// 'Bichonejo3', 128x32px
const unsigned char epd_bitmap_Bichonejo3 [] PROGMEM = {
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x81, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x04, 0x42, 0x20, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x05, 0x42, 0xa0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x05, 0x24, 0xa0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x05, 0x18, 0xa0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x04, 0x18, 0x20, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0e, 0x18, 0x70, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x08, 0x00, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x10, 0x00, 0x08, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x23, 0xc3, 0xc4, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x30, 0x80, 0x8c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x20, 0x18, 0x04, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x10, 0x5a, 0x08, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x08, 0x3c, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x04, 0x00, 0x20, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0b, 0x81, 0xd0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0xff, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x38, 0x00, 0x1c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x40, 0x18, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x44, 0x66, 0x22, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x68, 0x42, 0x16, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x38, 0x66, 0x1c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x04, 0x18, 0x20, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x06, 0x00, 0x60, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x81, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0d, 0x5a, 0xb0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0f, 0xff, 0xf0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};

// Array of all bitmaps for convenience.
const int epd_bitmap_BichonejoArray_LEN = 4;
const unsigned char* epd_bitmap_BichonejoArray[4] = {
  epd_bitmap_Bichonejo1,
  epd_bitmap_Bichonejo2,
  epd_bitmap_Bichonejo3,
  epd_bitmap_Bichonejo4
};

// ========================================
// SISTEMA DE MENÚ
// ========================================
enum SeccionMenu {
  MENU_INFO = 0,
  MENU_COMER = 1,
  MENU_ACARICIAR = 2,
  MENU_LIMPIAR = 3,
  MENU_DISCIPLINAR = 4,
  MENU_CURAR = 5,
  MENU_LUZ = 6,
  MENU_ALERTA = 7
};
int menuActual = MENU_INFO;

// ========================================
// FUNCIONES DE EEPROM
// ========================================
void guardarMascota() {
  int dir = 2;
  tiempoTranscurrido = tiempoAcumulado + (millis() - tiempoInicioSesion);
  EEPROM.put(EEPROM_MAGIC_ADDR, EEPROM_MAGIC);
  for (int i = 0; i < 10; i++) {
    EEPROM.write(dir++, miMascota.fase[i]);
  }
  EEPROM.put(dir, miMascota.salud); dir += sizeof(miMascota.salud);
  EEPROM.put(dir, miMascota.felicidad); dir += sizeof(miMascota.felicidad);
  EEPROM.put(dir, miMascota.saciado); dir += sizeof(miMascota.saciado);
  EEPROM.put(dir, miMascota.limpieza); dir += sizeof(miMascota.limpieza);
  EEPROM.put(dir, miMascota.educacion); dir += sizeof(miMascota.educacion);
  EEPROM.put(dir, miMascota.enfermedad); dir += sizeof(miMascota.enfermedad);
  EEPROM.put(dir, miMascota.tiempoVivo); dir += sizeof(miMascota.tiempoVivo);
  EEPROM.put(dir, miMascota.isDead); dir += sizeof(miMascota.isDead);
  EEPROM.put(dir, miMascota.despierto); dir += sizeof(miMascota.despierto);
  EEPROM.put(dir, lastComida); dir += sizeof(lastComida);
  EEPROM.put(dir, lastLimpieza); dir += sizeof(lastLimpieza);
  EEPROM.put(dir, lastMaldad); dir += sizeof(lastMaldad);
  EEPROM.put(dir, lastAburrimiento); dir += sizeof(lastAburrimiento);
  EEPROM.put(dir, lastEnfermedad); dir += sizeof(lastEnfermedad);
  EEPROM.put(dir, tiempoActual); dir += sizeof(tiempoActual);
  EEPROM.put(dir, tiempoTranscurrido); dir += sizeof(tiempoTranscurrido);
  tiempoUltimoGuardado = millis();
  EEPROM.put(dir, tiempoUltimoGuardado);
}

bool cargarMascota() {
  int dir = 2;
  uint16_t magic;
  EEPROM.get(EEPROM_MAGIC_ADDR, magic);
  if (magic != EEPROM_MAGIC) return false;
  for (int i = 0; i < 10; i++) miMascota.fase[i] = EEPROM.read(dir++);
  EEPROM.get(dir, miMascota.salud); dir += sizeof(miMascota.salud);
  EEPROM.get(dir, miMascota.felicidad); dir += sizeof(miMascota.felicidad);
  EEPROM.get(dir, miMascota.saciado); dir += sizeof(miMascota.saciado);
  EEPROM.get(dir, miMascota.limpieza); dir += sizeof(miMascota.limpieza);
  EEPROM.get(dir, miMascota.educacion); dir += sizeof(miMascota.educacion);
  EEPROM.get(dir, miMascota.enfermedad); dir += sizeof(miMascota.enfermedad);
  EEPROM.get(dir, miMascota.tiempoVivo); dir += sizeof(miMascota.tiempoVivo);
  EEPROM.get(dir, miMascota.isDead); dir += sizeof(miMascota.isDead);
  EEPROM.get(dir, miMascota.despierto); dir += sizeof(miMascota.despierto);
  EEPROM.get(dir, lastComida); dir += sizeof(lastComida);
  EEPROM.get(dir, lastLimpieza); dir += sizeof(lastLimpieza);
  EEPROM.get(dir, lastMaldad); dir += sizeof(lastMaldad);
  EEPROM.get(dir, lastAburrimiento); dir += sizeof(lastAburrimiento);
  EEPROM.get(dir, lastEnfermedad); dir += sizeof(lastEnfermedad);
  EEPROM.get(dir, tiempoActual); dir += sizeof(tiempoActual);
  EEPROM.get(dir, tiempoTranscurrido); dir += sizeof(tiempoTranscurrido);
  EEPROM.get(dir, tiempoUltimoGuardado); dir += sizeof(tiempoUltimoGuardado);
  return true;
}

// ========================================
// FUNCIONES DE DIBUJADO
// ========================================
void dibujarPantalla(int animationFrame = 0) {
  display.clearDisplay();

  // Dibujar iconos del menú solo si NO hay un mensaje activo
  if (!mostrandoMensaje) {
    if(menuActual == 0) display.drawBitmap(0, 0, epd_bitmap_Lupa, 32, 16, SSD1306_WHITE);
    else if(menuActual == 1) display.drawBitmap(32, 0, epd_bitmap_Comer, 32, 16, SSD1306_WHITE);
    else if(menuActual == 2) display.drawBitmap(64, 0, epd_bitmap_Acariciar, 32, 16, SSD1306_WHITE);
    else if(menuActual == 3) display.drawBitmap(96, 0, epd_bitmap_Limpiar, 32, 16, SSD1306_WHITE);
    else if(menuActual == 4) display.drawBitmap(0, 48, epd_bitmap_Educar, 32, 16, SSD1306_WHITE);
    else if(menuActual == 5) display.drawBitmap(32, 48, epd_bitmap_Curar, 32, 16, SSD1306_WHITE);
    else if(menuActual == 6) display.drawBitmap(64, 48, epd_bitmap_Luz, 32, 16, SSD1306_WHITE);
  }

  // Si la mascota está muerta, mostrar imagen de muerte y salir
  if (miMascota.isDead) {
    display.drawBitmap(0, 18, epd_bitmap_Died, 128, 32, SSD1306_WHITE);
    display.display();
    return;
  }
  // SIEMPRE dibujar el sprite de la mascota si está despierta
  if (miMascota.despierto) {
    if(strcmp(miMascota.fase, "huevo") == 0){
      display.drawBitmap(0, 18, epd_bitmap_Huevo, 128, 32, SSD1306_WHITE);
    }else{
      display.drawBitmap(0, 18, epd_bitmap_BichonejoArray[animationFrame], 128, 32, SSD1306_WHITE);
    }
  }

  display.display();
}

// ========================================
// FUNCIONES DE INICIALIZACIÓN
// ========================================
void inicializarMascota() {
  strcpy(miMascota.fase, "huevo");
  miMascota.salud = 5;
  miMascota.felicidad = 5;
  miMascota.saciado = 5;
  miMascota.limpieza = 5;
  miMascota.educacion = 2;
  miMascota.enfermedad = 0;
  miMascota.tiempoVivo = 0;
  miMascota.isDead = false;
  miMascota.despierto = true;
}

void setup() {
  Serial.begin(9600);
  delay(1000);
  Serial.println(F("=== Topigochi Iniciando ==="));
  pinMode(BOTON_1, INPUT_PULLUP);
  pinMode(BOTON_2, INPUT_PULLUP);
  pinMode(BOTON_3, INPUT_PULLUP);
  pinMode(BUZZER, OUTPUT);
  Wire.begin();
  byte error, address;
  int nDevices = 0;
  for(address = 1; address < 127; address++) {
    Wire.beginTransmission(address);
    error = Wire.endTransmission();
    if (error == 0) {
      Serial.print(F("Dispositivo I2C en 0x"));
      if (address < 16) Serial.print("0");
      Serial.println(address, HEX);
      nDevices++;
    }
  }
  if (nDevices == 0) Serial.println(F("No se encontraron dispositivos I2C!"));
  else Serial.println(F("Dispositivos I2C encontrados"));

  if(!display.begin(SSD1306_SWITCHCAPVCC, 0x3C)) {
    if(!display.begin(SSD1306_SWITCHCAPVCC, 0x3D)) {
      Serial.println(F("ERROR: No se pudo inicializar el display OLED"));
      delay(2000);
    }
  }

  display.clearDisplay();
  display.setTextSize(1);
  display.setTextColor(SSD1306_WHITE);
  display.setCursor(0, 0);
  display.println(F("Topigochi"));
  display.println(F("Iniciando..."));
  display.display();
  delay(2000);

  if (!cargarMascota()) {
    inicializarMascota();
    tiempoInicioSesion = millis();
    tiempoAcumulado = 0;
    tiempoTranscurrido = 0;
    lastComida = millis();
    lastLimpieza = millis();
    lastMaldad = millis();
    lastAburrimiento = millis();
    lastEnfermedad = millis();
  } else {
    tiempoInicioSesion = millis();
    tiempoAcumulado = tiempoTranscurrido;
  }

  display.clearDisplay();
  display.setCursor(0, 0);
  display.println(F("Presiona un boton"));
  display.display();
}

// ========================================
// LOOP PRINCIPAL
// ========================================
void loop() {
  // Manejar temporizador de mensajes
  if (mostrandoMensaje && millis() >= mensajeMostradoHasta) {
    mostrandoMensaje = false;
  }

  // Reloj interno
  tiempoActual = millis();
  tiempoTranscurrido = tiempoAcumulado + (tiempoActual - tiempoInicioSesion);

  // Chequear eventos
  cheackearEventos();

  // Timeout del menú
  if (menuActivo && (millis() - ultimaInteraccion > TIMEOUT_MENU)) {
    menuActivo = false;
  }

  // Lectura de botones
  if (digitalRead(BOTON_1) == LOW) {
    delay(debounceDelay);
    if (digitalRead(BOTON_1) == LOW) {
      if(!miMascota.despierto) {
        toggleLuz();
        tone(BUZZER, 400, 100);
        while(digitalRead(BOTON_1) == LOW);
      } else {
        navegarMenu();
        while(digitalRead(BOTON_1) == LOW);
      }
    }
  }

  if (digitalRead(BOTON_2) == LOW) {
    delay(debounceDelay);
    if (digitalRead(BOTON_2) == LOW) {
      if(!miMascota.despierto) {
        toggleLuz();
        tone(BUZZER, 400, 100);
        while(digitalRead(BOTON_2) == LOW);
      } else {
        ejecutarAccion();
        while(digitalRead(BOTON_2) == LOW);
      }
    }
  }

  if (digitalRead(BOTON_3) == LOW) {
    delay(debounceDelay);
    if (digitalRead(BOTON_3) == LOW) {
      if(!miMascota.despierto) {
        toggleLuz();
        tone(BUZZER, 400, 100);
        while(digitalRead(BOTON_3) == LOW);
      } else {
        cancelarAccion();
        while(digitalRead(BOTON_3) == LOW);
      }
    }
  }

  // Control de animación
  isAnimationRunning = miMascota.despierto && !mostrandoMensaje;
  if (isAnimationRunning && millis() - lastFrameTime > frameDelay) {
    animationFrame = (animationFrame + 1) % epd_bitmap_BichonejoArray_LEN;
    lastFrameTime = millis();
  }

  // Dibujar pantalla SIEMPRE al final
  dibujarPantalla(animationFrame);
}

// ========================================
// FUNCIONES DE EVENTOS
// ========================================
void cheackearEventos() {
    Serial.print("[DEBUG] tiempoVivo: ");
    Serial.print(miMascota.tiempoVivo);
    Serial.print(" | faseActual: ");
    Serial.print(faseActual);
    Serial.print(" | fase: ");
    Serial.println(miMascota.fase);
  if(!miMascota.isDead) {
    // Evolución de fase automática y actualización de intervalos
    if (faseActual == 0 && miMascota.tiempoVivo >= 6000) { // huevo -> bebe
      faseActual = 1;
      strcpy(miMascota.fase, "bebe");
      tiempoTransicionFase = 86400000; // bebe -> adulto (24h)
      intervaloComida = 7200000;
      intervaloLimpieza = 7200000;
      intervaloMaldad = 86400000;
      intervaloAburrimiento = 7200000;
      intervaloEnfermedad = 86400000;
      miMascota.tiempoVivo = 0;
      mostrarMensaje("¡Evoluciono!");
      // Melodía de celebración
      tone(BUZZER, 1200, 200);
      delay(200);
      tone(BUZZER, 1600, 200);
      delay(200);
      tone(BUZZER, 2000, 400);
      delay(400);
      noTone(BUZZER);
    } else if (faseActual == 1 && miMascota.tiempoVivo >= 86400000) { // bebe -> adulto
      faseActual = 2;
      strcpy(miMascota.fase, "adulto");
      tiempoTransicionFase = 259200000; // adulto -> anciano (72h)
      intervaloComida = 14400000;
      intervaloLimpieza = 14400000;
      intervaloMaldad = 86400000;
      intervaloAburrimiento = 14400000;
      intervaloEnfermedad = 86400000;
      miMascota.tiempoVivo = 0;
      mostrarMensaje("¡Evoluciono!");
    } else if (faseActual == 2 && miMascota.tiempoVivo >= 259200000) { // adulto -> anciano
      faseActual = 3;
      strcpy(miMascota.fase, "anciano");
      tiempoTransicionFase = 86400000; // fin (24h)
      intervaloComida = 10800000;
      intervaloLimpieza = 10800000;
      intervaloMaldad = 86400000;
      intervaloAburrimiento = 10800000;
      intervaloEnfermedad = 86400000;
      miMascota.tiempoVivo = 0;
      mostrarMensaje("¡Evoluciono!");
    }
    // Usar los intervalos actuales
    if (tiempoActual - lastComida >= intervaloComida) {
      if (miMascota.saciado > 1) miMascota.saciado--;
      else miMascota.isDead = true;
      lastComida = tiempoActual;
    }
    if (tiempoActual - lastLimpieza >= intervaloLimpieza) {
      if (miMascota.limpieza > 1) miMascota.limpieza--;
      else miMascota.isDead = true;
      lastLimpieza = tiempoActual;
    }
    if (tiempoActual - lastMaldad >= intervaloMaldad) {
      if (miMascota.educacion > 1) miMascota.educacion--;
      else miMascota.isDead = true;
      lastMaldad = tiempoActual;
    }
    if (tiempoActual - lastAburrimiento >= intervaloAburrimiento) {
      if (miMascota.felicidad > 1) miMascota.felicidad--;
      else miMascota.isDead = true;
      lastAburrimiento = tiempoActual;
    }
    if (tiempoActual - lastEnfermedad >= intervaloEnfermedad) {
      if (miMascota.enfermedad < 5) miMascota.enfermedad++;
      else miMascota.isDead = true;
      lastEnfermedad = tiempoActual;
    }
    // Sumar tiempo vivo
    miMascota.tiempoVivo += millis() - tiempoActual;
  }
}

// ========================================
// FUNCIONES DEL MENÚ
// ========================================
void navegarMenu() {
  menuActivo = true;
  ultimaInteraccion = millis();
  menuActual = (menuActual + 1) % MENU_ALERTA;
  tone(BUZZER, 800, 50);
}

void ejecutarAccion() {
  ultimaInteraccion = millis();
  tone(BUZZER, 1200, 100);
  if(miMascota.isDead && menuActual != MENU_CURAR) {
    mostrarMensaje("Muerto!");
    return;
  }else{
    switch(menuActual) {
      case MENU_INFO: mostrarInformacion(); break;
      case MENU_COMER: darDeComer(); break;
      case MENU_ACARICIAR: acariciar(); break;
      case MENU_LIMPIAR: limpiar(); break;
      case MENU_DISCIPLINAR: disciplinar(); break;
      case MENU_CURAR: curar(); break;
      case MENU_LUZ: toggleLuz(); break;
    }
  }
}

void cancelarAccion() {
  tone(BUZZER, 600, 100);
  menuActivo = false;
}

// ========================================
// FUNCIONES DE ACCIÓN (sin delay)
// ========================================
void mostrarInformacion() {
  display.clearDisplay();
  display.setTextSize(1);
  display.setTextColor(SSD1306_WHITE);
  display.setCursor(0, 0);
  display.print(F("Fase: ")); display.println(miMascota.fase);
  display.print(F("Salud: ")); display.println(miMascota.salud);
  display.print(F("Feliz: ")); display.println(miMascota.felicidad);
  display.print(F("Hambre: ")); display.println(miMascota.saciado);
  display.print(F("Limpio: ")); display.println(miMascota.limpieza);
  int horas = (tiempoTranscurrido / 3600000) % 24;
  int minutos = (tiempoTranscurrido / 60000) % 60;
  display.print(F("Tiempo: "));
  if (horas < 10) display.print("0"); display.print(horas); display.print(":");
  if (minutos < 10) display.print("0"); display.println(minutos);
  display.display();
}

void darDeComer() {
  if (miMascota.saciado < 5) {
    miMascota.saciado++;
    mostrarMensaje("Comiendo!");
  } else {
    mostrarMensaje("Lleno!");
  }
}

void acariciar() {
  if (miMascota.felicidad < 5) {
    miMascota.felicidad++;
    mostrarMensaje("Feliz!");
  } else {
    mostrarMensaje("Muy feliz!");
  }
}

void limpiar() {
  if (miMascota.limpieza < 5) {
    miMascota.limpieza++;
    mostrarMensaje("Limpio!");
  } else {
    mostrarMensaje("Muy limpio!");
  }
}

void disciplinar() {
  if (miMascota.educacion < 5) {
    miMascota.educacion++;
    mostrarMensaje("Educado!");
  } else {
    mostrarMensaje("Bien educado!");
  }
}

void curar() {
  if (miMascota.isDead) {
    inicializarMascota();
    return;
  }
  if (miMascota.enfermedad > 0) {
    miMascota.enfermedad--;
    mostrarMensaje("Curado!");
  } else {
    mostrarMensaje("Ya sano!");
  }
}

void toggleLuz() {
  miMascota.despierto = !miMascota.despierto;
  if (miMascota.despierto) {
    mostrarMensaje("Despierto!");
    display.ssd1306_command(SSD1306_DISPLAYON);
  } else {
    display.clearDisplay();
    display.ssd1306_command(SSD1306_DISPLAYOFF);
  }
}

// ========================================
// FUNCIONES DE UTILIDAD
// ========================================
void mostrarMensaje(const char* mensaje) {
  display.clearDisplay();
  display.setTextSize(2);
  display.setTextColor(SSD1306_WHITE);
  display.setCursor(10, 25);
  display.println(mensaje);
  display.display();
  tone(BUZZER, 1000, 100);
  delay(2000);
  mostrandoMensaje = true;
  mensajeMostradoHasta = millis() + 500; // 2 segundos
}
